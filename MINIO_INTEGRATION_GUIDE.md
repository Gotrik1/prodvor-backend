# Руководство по Интеграции с MinIO для AI-Ассистента

Это руководство объясняет, как правильно взаимодействовать с S3-совместимым хранилищем MinIO в рамках данного проекта. Ключевая особенность архитектуры — **фронтенд и бэкенд развернуты в разных облачных средах**, что требует особого подхода к загрузке и доступу к файлам.

## 1. Основная Проблема: CORS и Безопасность

Фронтенд, работающий в браузере пользователя (например, на Firebase Hosting), **не может напрямую** отправлять запросы на сервер MinIO, который работает в другом окружении (Docker-контейнер). Браузер заблокирует такие запросы из-за политики безопасности **CORS (Cross-Origin Resource Sharing)**.

Кроме того, **никогда нельзя передавать на клиентскую сторону** (в браузер) секретные ключи доступа (`S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`).

## 2. Решение: Двухэтапная Загрузка через Presigned URLs

Чтобы обойти эти ограничения, мы используем безопасную схему, управляемую нашим бэкендом. **AI-ассистент никогда не должен пытаться взаимодействовать с MinIO напрямую.** Всегда используйте эндпоинты бэкенда.

Процесс загрузки файла состоит из 3 шагов:

### Шаг 1: Инициализация (Клиент -> Бэкенд)

-   **Действие:** Клиент (фронтенд) отправляет `POST` запрос на эндпоинт бэкенда `/api/v1/media/upload/init`.
-   **Параметры:** В теле запроса передаются метаданные файла: `content_type` (например, '''image/jpeg''') и `size` (размер в байтах).
-   **Что делает бэкенд:**
    1.  Проверяет права доступа пользователя по JWT токену.
    2.  Создает в таблице `uploads` запись о начале сессии загрузки.
    3.  Генерирует специальную, временную, одноразовую **"подписанную" ссылку (presigned URL)**, которая разрешает `PUT` запрос на конкретный путь в MinIO.
-   **Результат:** Бэкенд возвращает `uploadId` и эту `uploadUrl`.

### Шаг 2: Прямая Загрузка (Клиент -> MinIO)

-   **Действие:** Клиент использует полученный `uploadUrl` для загрузки файла **напрямую в MinIO** методом `PUT`.
-   **Важно:** В этот URL уже "встроена" подпись, которая разрешает эту конкретную операцию. Загрузка происходит напрямую, минуя наш бэкенд, что экономит его ресурсы.

### Шаг 3: Завершение (Клиент -> Бэкенд)

-   **Действие:** После успешной загрузки в MinIO клиент отправляет `POST` запрос на `/api/v1/media/upload/complete`.
-   **Параметры:** В теле запроса передаются `uploadId` и `path`, полученные на Шаге 1.
-   **Что делает бэкенд:**
    1.  Находит сессию загрузки в своей базе данных.
    2.  **Не доверяя клиенту**, отправляет внутренний запрос в MinIO, чтобы убедиться, что файл действительно существует и его размер совпадает с заявленным.
    3.  Если проверка успешна, обновляет статус в таблице `uploads` на '''uploaded'''.
-   **Результат:** Бэкенд возвращает постоянную публичную ссылку на файл, которую можно использовать для его отображения.

## 3. Публичный Доступ (Как достучаться из другого облака)

Это ключевой вопрос. Если MinIO работает по внутреннему адресу `http://localhost:9002`, как фронтенд, развернутый на `https://my-app.web.app`, сможет его увидеть?

**Решение: Проксирование через Firebase Hosting.**

В конфигурации Firebase Hosting (`firebase.json`) необходимо настроить `rewrites` (правила перезаписи). Это правило будет перенаправлять все запросы с публичного пути на наш бэкенд/MinIO.

**Пример конфигурации `firebase.json`:**

```json
{
  "hosting": {
    "public": "build", // Ваша папка со статикой фронтенда
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      // Все запросы, начинающиеся с /api/, перенаправлять на наш бэкенд
      {
        "source": "/api/**",
        "function": "api" // Название вашей Cloud Function или Cloud Run сервиса
      },
      // Все запросы к S3 перенаправлять напрямую на MinIO
      // ВАЖНО: MinIO должен быть доступен по публичному IP или домену
      {
        "source": "/s3/**",
        "destination": "http://<ПУБЛИЧНЫЙ_IP_СЕРВЕРА_MINIO>:9002/**"
      }
    ],
    //... другие настройки
  }
}
```

Кроме того, на самом **MinIO необходимо настроить CORS**, чтобы он принимал `PUT` запросы от домена вашего фронтенда (`https://my-app.web.app`).

### Итог для AI:

1.  **Для загрузки:** Всегда следуй трехшаговой процедуре (`init`, `PUT`, `complete`).
2.  **Для отображения:** Используй публичный URL, возвращаемый эндпоинтом `complete`. Этот URL должен быть уже сконфигурирован с учетом прокси (например, `https://my-app.web.app/s3/bucket-name/path/to/file.jpg`).
3.  **Никогда не используй** адреса `localhost` или `minio` в коде, предназначенном для клиента. Публичные URL формирует только бэкенд.
