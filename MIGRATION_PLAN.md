# План миграции: APIFlask → FastAPI

Документ описывает полный процесс миграции бэкенда с APIFlask на FastAPI, включая анализ, выбор стека, поэтапный перенос, тестирование, эксплуатацию и финальную очистку от Flask.

## 1. Отчёт по анализу и инвентаризации

### 1.1. Инвентаризация стека, зависимостей и точек входа

| Компонент                      | Описание и расположение                                                                                                                                      |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Создание приложения**        | Фабрика `create_app()` в `app/__init__.py`; экземпляр `apiflask.APIFlask`.                                                                                   |
| **Зависимости Flask**          | `APIFlask`, `Flask-SQLAlchemy`, `Flask-Migrate`, `Flask-Bcrypt`, `Flask-JWT-Extended`, `Flask-Cors`, возможные вспомогательные плагины.                      |
| **Схема БД и ORM**             | Модели в `app/models.py`; подключение через `Flask-SQLAlchemy`; миграции Alembic через `Flask-Migrate` и скрипты `run_migrations.sh`/аналоги.                |
| **Аутентификация/Авторизация** | JWT (`Flask-JWT-Extended`): `/login`, `/register`, `/refresh`, `/logout`; роли (`player`, `referee`, `coach`) при регистрации; коллбеки в `app/__init__.py`. |
| **Интеграции**                 | S3 (`S3Service`), конфиг из env. (Допущение: других интеграций нет.)                                                                                         |
| **OpenAPI/Swagger**            | Генерируется APIFlask; кастомизация servers/security в `app/__init__.py`; схемы часто в docstrings.                                                          |
| **Скрипты/старты**             | Dev: `devserver.sh` (`flask run`); Prod: `entrypoint.sh`, `docker-compose.yml`; миграции: `run_migrations.sh`.                                               |
| **CORS**                       | `Flask-Cors` на `"/api/v1/*"`; в prod — риск `*`.                                                                                                            |
| **Лимиты/кеш/очереди**         | Не зафиксированы. (Допущение: отсутствуют.)                                                                                                                  |

### 1.2. Сводка по контрактам API (минимум)

* Таблица эндпоинтов: путь, метод, авторизация, структура запроса/ответа, коды, пагинация/сортировка/фильтры.
* Отдельно: **загрузки файлов** (`multipart/form-data`, лимиты/ошибки 413), **стрим-ответы**, **вебсокеты** (если появятся).
* Формат ошибок: единый вид, ожидаемый фронтом (фиксируем точно).
* Нейминг полей (snake/camel), даты/время (UTC ISO-8601), числовая точность (например, денежные типы).

### 1.3. Технические долги и риски

| Категория        | Риск/долг                            | Влияние                                                  |
| ---------------- | ------------------------------------ | -------------------------------------------------------- |
| Зависимости      | Жёсткая связка с Flask-плагинами     | Нужны прямые аналоги/отвязка.                            |
| Ошибки/валидация | Разные форматы ошибок (abort vs jwt) | Нужен слой совместимости ошибок.                         |
| CORS             | `*` в prod                           | Сразу разделить dev/prod списки.                         |
| Запуск           | Dev-сервер (`flask run`)             | Перейти на ASGI везде.                                   |
| 422/400          | Разнобой по валидации                | Синхронизировать коды/тела ответов.                      |
| Пагинация        | Потенциальная несогласованность      | Зафиксировать единый контракт (limit/offset или cursor). |

---

## 2. Выбранный стек и стратегия миграции

### 2.1. Целевой технологический стек

* **FastAPI** (ASGI)
* **SQLAlchemy 2.0** (синхронно на старте)
* **Alembic** напрямую
* **Pydantic v2** (схемы)
* **pydantic-settings** (конфиг из `.env`)
* **OAuth2PasswordBearer + PyJWT** (JWT, refresh-flow)
* **CORSMiddleware**
* **fastapi-limiter + Redis** (rate limiting, при brute-force на логин/ключевые ручки)
* **Structlog** (или Loguru) — структурные логи
* **Boto3** (S3, позже можно aioboto3)
* **Gunicorn + uvicorn.workers.UvicornWorker** (prod)
* (Опционально) **OpenTelemetry** + Prometheus/Grafana (обозримость)

### 2.2. Стратегия “Strangler Fig”

* Параллельный подъём FastAPI.
* Прокси (Kong/Nginx) как единая точка входа.
* Поэтапный перехват трафика по маршрутам (`/api/v1/auth/*` → FastAPI и далее).
* Контрактные тесты на каждом шаге.
* Полное переключение → вывод Flask из эксплуатации.

---

## 3. Архитектура целевого приложения (без кода)

### 3.1. Структура

* `app/core/` — настройки, БД, безопасность, логирование, обработчики исключений, openapi-кастомизация, лимитирование.
* `app/models/` — ORM-модели, не зависящие от веб-фреймворка.
* `app/schemas/` — Pydantic-схемы запросов/ответов.
* `app/services/` — бизнес-логика, S3, внешние клиенты.
* `app/routers/` — APIRouter по доменам (auth, users, sports, …).
* `app/middleware/` — совместимость ошибок и др.
* `main.py` — сборка приложения (CORS, middleware, маршруты, health/ready).

### 3.2. Ответственность слоёв

* **main** — инициализация и склейка.
* **routers** — HTTP-контракт, валидация, вызов сервиса.
* **schemas** — формальные модели I/O.
* **services** — доменная логика.
* **models** — доступ к данным.
* **core** — кросс-сечения (config, db, security, logging, openapi, limits).

---

## 4. Дорожная карта миграции

| Фаза                         | Задачи                                                                                                                                                                                      | Риски/минимизация                                                              | DoD                                                     |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ | ------------------------------------------------------- |
| **A. Подготовка**            | Создать каркас на FastAPI; вынести настройки; подключить SQLAlchemy 2.0; настроить Alembic; `/healthz`, `/readyz`.                                                                          | Несовместимость env/БД. → Сверка переменных, отдельные профили dev/stage/prod. | Приложение стартует, health/ready OK, Alembic готов.    |
| **B. Безопасность**          | JWT (access/refresh), ротация refresh, blacklist (Redis при необходимости), зависимость current user; слой совместимости ошибок; security-headers.                                          | Несовпадения форматов/TTL. → Таблица сопоставления и тесты.                    | Защищённые ручки работают, ошибки совпадают с эталоном. |
| **C. Маршруты 1-й очереди**  | Перенос `/api/v1/auth/*`, `/api/v1/users/*`; лимитирование на логин; структурные логи; единая пагинация.                                                                                    | “Тихие” расхождения контрактов. → Контрактные тесты и golden-ответы.           | Ручки работают, контракты совпадают.                    |
| **D. Проксирование и тесты** | Маршрутизация часть путей на FastAPI; smoke/контрактные; лёгкий нагрузочный прогон; **shadow traffic** (опционально) — зеркалирование запросов на новый бэкенд без влияния на пользователя. | Конфигурация прокси. → Старт с 1 домена.                                       | Роуты стабильно обрабатываются FastAPI, тесты проходят. |
| **E. Полный перенос**        | Доменно переносить оставшиеся блюпринты; актуализировать OpenAPI; включить метрики/трейсы.                                                                                                  | Регрессии. → CI контрактные + сценарные тесты на каждый мерж.                  | 100% трафика на FastAPI.                                |
| **F. Оптимизация (опц.)**    | Async-клиенты для тяжёлых I/O; кэш Redis/ETag; сжатие; профилирование БД (индексы, N+1).                                                                                                    | Сложности async. → Точечно, где даёт выгоду.                                   | Улучшение p95/p99, снижение нагрузки.                   |
| **G. Финальная очистка**     | Удаление Flask-зависимостей/файлов; Docker/entrypoint под ASGI; обновление CI/CD; документация.                                                                                             | Случайное удаление нужного. → По чек-листу с ревью.                            | `pip freeze` без Flask; все тесты зелёные.              |

---

## 5. Политика совместимости и рисков

* **Формат ошибок**: единый JSON (зафиксировать точный вид, коды, поля); 422 валидации приводятся к тому же виду.
* **Дата/время**: UTC, ISO-8601; единая сериализация.
* **Нейминг полей**: сохранить текущую конвенцию (snake/camel) — формально описать.
* **Пагинация/сортировка/фильтры**: стандартизировать; документировать в OpenAPI.
* **CORS**: явные списки для dev/stage/prod; предзаявка (preflight); синхронизация с фронтом `allowedDevOrigins`.
* **Загрузки**: presigned-URL для прямых загрузок в S3; ограничения размера/типа; таймауты; защищённые scope/права.
* **Коды**: строгая матрица соответствия (старый→новый) по всем эндпоинтам.
* **OpenAPI**: стабильные `operationId`, теги, servers; ручная донастройка при расхождениях.

---

## 6. План тестирования

| Тип            | Цель                             | Метод                                         | Критерии успеха                                 |
| -------------- | -------------------------------- | --------------------------------------------- | ----------------------------------------------- |
| Контрактные    | Совпадение ответов со старым API | Golden-файлы, сравнение тела/заголовков/кодов | 100% совпадение на покрытых ручках              |
| Сценарные      | Бизнес-флоу end-to-end           | Pytest + httpx/requests                       | Все сценарии зелёные                            |
| Нагрузочные    | Производительность/устойчивость  | k6/Locust (профили RPS)                       | p95/p99 в SLO, ошибки <0.1%                     |
| CORS           | Политика доменов                 | curl с Origin, браузерные прогоны             | Разрешённые проходят, прочие блокируются        |
| Лимиты         | Защита от брута                  | burst-скрипты                                 | 429 по матрице лимитов                          |
| Health/Ready   | Готовность сервисов              | `/healthz`, `/readyz`                         | Чёткая семантика, корректные статусы            |
| Shadow traffic | Скрытая проверка                 | Зеркалирование запросов на FastAPI            | Расхождения < порога, логи без критичных ошибок |

---

## 7. План финальной очистки от Flask

| Действие     | Что сделать                                                                         | Критерий                                       |
| ------------ | ----------------------------------------------------------------------------------- | ---------------------------------------------- |
| Зависимости  | Удалить `Flask*`, `APIFlask*`, связанные плагины из зависимостей                    | `pip freeze` без Flask                         |
| Код          | Удалить блюпринты, фабрики, dev-скрипты (`flask run`), `.flaskenv`, swagger-композы | Поиск по `flask`/`apiflask` ничего не находит  |
| Docker       | Единственный путь запуска — ASGI; миграции через Alembic; healthchecks              | `docker compose up` стабильно поднимает сервис |
| Прокси       | Удалить старый upstream на Flask из Kong/Nginx                                      | Прокси указывает только на FastAPI             |
| CI/CD        | Обновить пайплайн: миграции Alembic, тесты, линт, сборка, секьюрити-сканы           | Пайплайн зелёный                               |
| Документация | Обновить README/оперативные инструкции                                              | Новичок может развернуть проект с нуля         |

---

## 8. Эксплуатация и SLO

* **SLO**: целевые p95/p99, ошибка-рейт, доступность.
* **Метрики**: RPS, latency, коды ответов, пул БД, Redis, лимиты, S3-ошибки.
* **Логи**: JSON, маскирование PII/секретов, `request-id`/`trace-id`.
* **Трейсинг**: сквозные traceparent/baggage (фронт→бэк).
* **Алертинги**: по SLO/SLA; on-call регламент.
* **Runbook**: чек-листы инцидентов, перезапусков, деградаций (DB недоступен, Redis недоступен, S3 ошибки).

---

## 9. Безопасность и соответствие

* **JWT**: раздельные TTL для access/refresh; ротация refresh; опциональный blacklist (Redis); clock skew.
* **Пароли**: политика и параметры хэша; миграция хэшей (если меняются).
* **Заголовки**: HSTS, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy, CSP.
* **Доступы**: роли/права (RBAC/ABAC); минимально необходимые IAM-права к S3.
* **Секреты**: хранение в секрет-менеджере окружения; ротация.
* **Данные**: политика логирования и удаления персональных данных; экспорт/удаление (если требуется по регуляторике).

---

## 10. База данных и миграции

* Единый Alembic (`alembic.ini/env.py`) без Flask-обвязки.
* Зафиксировать начальный head; стратегия миграции со “старых” состояний.
* Идемпотентность критичных POST (идемпотентные ключи).
* Пулы соединений: размер/таймауты/`pre_ping`; мониторинг.
* N+1 и индексы: чек-лист и профилирование.
* Бэкапы и **rollback-план** на каждый релиз.

---

## 11. Версионирование и изменения

* Жёстко закреплённый `/api/v1` с планом `/v2`.
* Таблица деприкаций (если что-то меняется) с датами и периодом поддержки.
* Управление изменениями: согласование с фронтом, окно миграции, fallback.

---

## 12. Supply-chain & контейнерная безопасность

* Dependency audit (SCA), обновления уязвимостей.
* Лицензии зависимостей — соответствие политике.
* SBOM (software bill of materials) в CI.
* Базовые образы с регулярными security-патчами; non-root; минимальные привилегии; read-only FS (где возможно).

---


