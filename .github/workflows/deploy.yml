name: Deploy backend to local PC via Tailscale

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Вместо tailscale/github-action — ставим клиент вручную и поднимаем с authkey
      - name: Install & Connect to Tailscale (manual)
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --accept-routes=true
          tailscale status
          tailscale ip -4

      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.TAILSCALE_HOST }}" >> ~/.ssh/known_hosts

      - name: Pull & restart backend on Windows host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host:     ${{ secrets.TAILSCALE_HOST }}
          username: ${{ secrets.WINDOWS_USER }}
          key:      ${{ secrets.TAILSCALE_SSH_KEY }}
          port:     22
          script: |
            REM ====== ПУТЬ К БЭКУ ======
            cd /d E:\prodvor\backend

            REM ====== GIT SYNC ======
            git fetch --all --prune
            git reset --hard origin/main

            REM ====== DEPENDENCIES ======
            if exist pnpm-lock.yaml (
              pnpm -v >NUL 2>&1 && pnpm install --frozen-lockfile || npm install --no-audit --no-fund
            ) else (
              npm install --no-audit --no-fund
            )

            REM ====== MIGRATIONS (если используешь Prisma) ======
            if exist node_modules\.bin\prisma (
              npx prisma migrate deploy || echo "skip prisma"
            )

            REM ====== RESTART (выбери один вариант) ======
            taskkill /im node.exe /f >NUL 2>&1
            start "" cmd /c "npm run start:dev"

            REM PM2:
            REM npx pm2 startOrReload ecosystem.config.js --only backend

            REM Docker:
            REM cd /d E:\prodvor
            REM docker compose pull && docker compose up -d --build
