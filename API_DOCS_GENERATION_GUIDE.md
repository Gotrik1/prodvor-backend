
# Инструкция по обновлению и генерации API документации (Swagger)

Этот документ описывает процедуру для регенерации файла `swagger.json`, который используется для отображения интерактивной API документации.

## Введение

Проект использует библиотеку `flasgger` для создания документации из комментариев (docstrings) непосредственно в коде. Однако, для оптимизации производительности, документация не генерируется "на лету" при каждом запуске сервера. Вместо этого, она генерируется один раз в статический файл `app/static/swagger.json` с помощью специальной команды.

Если вы вносите изменения в API (добавляете новые эндпоинты, меняете параметры существующих), вам необходимо вручную запустить процесс регенерации, чтобы они отразились в документации.

## Проблема, с которой мы столкнулись

Изначально, при попытке обновить документацию, мы столкнулись с несколькими проблемами:

1.  **Отсутствующие эндпоинты**: Некоторые разделы API (в частности, `Legacy`) полностью отсутствовали в документации, так как автоматический генератор не мог их "увидеть".
2.  **Неработающая команда генерации**: Команда `flask swagger generate`, предназначенная для обновления, не работала из-за ошибок в коде и отсутствующих зависимостей.

## Шаги для корректной генерации документации

Вот пошаговый процесс, который мы выполнили, чтобы все исправить. Эти шаги уже выполнены, но они служат объяснением и руководством на будущее.

### Шаг 1: Добавление разметки для Flasgger

Чтобы генератор "увидел" эндпоинт, он должен быть декорирован с помощью `@swag_from` и содержать описание в формате YAML.

**Проблема**: Маршруты в `app/routes/legacy.py` не имели таких комментариев, поэтому генератор их игнорировал.

**Решение**: Мы добавили к каждому маршруту в `app/routes/legacy.py` блоки `@swag_from`.

*Пример до:* 
```python
@legacy_bp.route('/tournaments', methods=['GET'])
def get_tournaments():
    tournaments = Tournament.query.all()
    return jsonify([t.to_dict() for t in tournaments])
```

*Пример после:*
```python
from flasgger.utils import swag_from

@legacy_bp.route('/tournaments', methods=['GET'])
@swag_from({
    'tags': ['Legacy'],
    'summary': 'Get all tournaments',
    'responses': {
        200: {
            'description': 'A list of tournaments.'
        }
    }
})
def get_tournaments():
    """Retrieve all tournaments."""
    tournaments = Tournament.query.all()
    return jsonify([t.to_dict() for t in tournaments])
```

### Шаг 2: Установка недостающих зависимостей

**Проблема**: Скрипт генерации (`manage.py`) требовал пакет `flask-restful`, который не был указан в зависимостях проекта.

**Решение**:
1.  Мы установили пакет: `pip install flask-restful`.
2.  Мы добавили его в файл `requirements.txt`, чтобы он устанавливался автоматически в будущем.

### Шаг 3: Исправление фабрики приложения

**Проблема**: Скрипт генерации пытался вызвать функцию `create_app` с параметром `init_swagger=False`, но функция не была готова его принять.

**Решение**: Мы изменили функцию `create_app` в файле `app/__init__.py`, чтобы она принимала этот аргумент и включала/отключала инициализацию Swagger.

*Было:*
```python
def create_app():
    # ...
    Swagger(app)
    # ...
```

*Стало:*
```python
def create_app(init_swagger=True):
    # ...
    if init_swagger:
        Swagger(app)
    # ...
```

### Шаг 4: Запуск команды генерации

После выполнения всех исправлений, для обновления документации теперь достаточно выполнить одну команду в терминале.

**Важно**: Перед запуском убедитесь, что у вас активировано виртуальное окружение.

```bash
# 1. Активировать виртуальное окружение
source .venv/bin/activate

# 2. Запустить команду генерации
flask swagger generate
```

Эта команда автоматически проанализирует весь код, найдет все эндпоинты, размеченные с помощью `@swag_from`, и создаст свежий, полный файл `app/static/swagger.json`.

После этого ваша API документация будет полностью обновлена.
